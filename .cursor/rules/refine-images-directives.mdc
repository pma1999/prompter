---
globs: prompter/src/lib/server/refineService.ts
description: Conditional directive note about reference images; applied consistently to all builders
---
## Directives – Conditional note for reference images

When reference images are present, the directive builders append a single bullet line to inform the refiner that:

"If reference image(s) are attached to this request, consider them as grounding visual context when drafting the prompt. These same images will also be sent to the gemini-2.5-flash-image generation step."

### Implementation
- `buildDirective`, `buildPreviewDirective`, y `buildFinalDirective` aceptan `hasImages` para incluir la nota.
- En caché explícita, `buildCachedPrefix` también incluye la nota cuando `hasImages` es true, para que quede en el prefijo cacheado.
- `refine(...)` calcula `hasImages` desde `req.context?.image?.assets` y lo propaga a todos los builders.

